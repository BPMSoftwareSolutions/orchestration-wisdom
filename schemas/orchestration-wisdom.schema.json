{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/orchestration-wisdom.schema.json",
  "title": "Orchestration Wisdom Schema (OWS) v1.1",
  "description": "High-Quality Orchestration Framework with Quality Rubric and Observability",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "meta",
    "domain",
    "pattern",
    "actors",
    "caseDefinition",
    "orchestrationQuality",
    "diagramBudget",
    "flows",
    "outputs"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "1.1.0"
    },
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "createdAt", "author", "audience"],
      "properties": {
        "id": { "type": "string", "description": "Stable unique ID for the pattern/article (slug or UUID)." },
        "title": { "type": "string" },
        "createdAt": { "type": "string", "format": "date-time" },
        "author": { "type": "string" },
        "audience": {
          "type": "array",
          "items": { "type": "string", "enum": ["exec", "ops", "product", "engineering", "support", "customer_success"] },
          "minItems": 1
        },
        "tags": { "type": "array", "items": { "type": "string" } },
        "disclaimer": {
          "type": "string",
          "description": "Optional: statement about illustrative modeling and non-confidential assumptions."
        }
      }
    },
    "domain": {
      "type": "object",
      "additionalProperties": false,
      "required": ["industry", "topic", "useCase"],
      "properties": {
        "industry": { "type": "string", "description": "e.g., Automotive, Home Remodeling, Insurance." },
        "topic": { "type": "string", "description": "e.g., Warranty defect escalation." },
        "useCase": { "type": "string", "description": "Short label for the scenario." }
      }
    },
    "pattern": {
      "type": "object",
      "additionalProperties": false,
      "required": ["problemStatement", "rootCause", "designPrinciples", "successCriteria"],
      "properties": {
        "problemStatement": { "type": "string" },
        "rootCause": {
          "type": "array",
          "items": { "type": "string" },
          "description": "System-level causes, not people."
        },
        "designPrinciples": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Rules the orchestrated solution must follow (ownership, SLA-driven routing, visibility, etc.)."
        },
        "successCriteria": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Observable outcomes (e.g., ETA within 48 hours, escalation within SLA breach window)."
        }
      }
    },
    "actors": {
      "type": "array",
      "minItems": 3,
      "maxItems": 7,
      "description": "Maximum 7 actors to ensure clarity and avoid complexity.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "label", "role"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[A-Za-z][A-Za-z0-9_]{1,30}$",
            "description": "Mermaid-safe participant id."
          },
          "label": { "type": "string", "description": "Human label (can include emoji)." },
          "role": { "type": "string", "description": "What this actor is responsible for." }
        }
      }
    },
    "caseDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["trigger", "inputs", "customerImpact", "assumptions", "boundaries"],
      "properties": {
        "trigger": { "type": "string", "description": "What starts the case." },
        "inputs": { "type": "array", "items": { "type": "string" } },
        "customerImpact": { "type": "string", "description": "Why this hurts." },
        "assumptions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "What we're assuming to model the flow (no private info)."
        },
        "boundaries": {
          "type": "array",
          "items": { "type": "string" },
          "description": "What this model does NOT claim (e.g., not company-specific internal facts)."
        }
      }
    },
    "orchestrationQuality": {
      "type": "object",
      "additionalProperties": false,
      "required": ["goals", "constraints", "requiredSignals", "requiredDecisionPoints", "rubric"],
      "description": "Orchestration quality requirements and rubric; all generators must score ≥30/40 and no dimension <3.",
      "properties": {
        "goals": {
          "type": "array",
          "minItems": 2,
          "items": { "type": "string" },
          "description": "Orchestration goals (e.g., reduce time-to-ETA, enforce ownership, eliminate manual handoffs)."
        },
        "constraints": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" },
          "description": "Hard limits (e.g., no more than 7 actors, no private data, no unverifiable claims)."
        },
        "requiredSignals": {
          "type": "array",
          "minItems": 3,
          "items": {
            "type": "string",
            "enum": [
              "case_created",
              "ownership_assigned",
              "sla_started",
              "eta_provided",
              "capacity_unavailable",
              "sla_breach_risk",
              "sla_breached",
              "escalation_triggered",
              "work_reassigned",
              "customer_notified",
              "case_closed"
            ]
          },
          "description": "Observable signals that must be emitted by steps in the orchestration."
        },
        "requiredDecisionPoints": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": [
              "capacity_available",
              "sla_breach_handling",
              "eligibility_validation",
              "parts_or_materials_delay",
              "vendor_acceptance",
              "customer_scheduling_choice"
            ]
          },
          "description": "Decision points that must be modeled via alt branches."
        },
        "rubric": {
          "type": "object",
          "additionalProperties": false,
          "required": ["minTotalScore", "minDimensionScore", "dimensions"],
          "properties": {
            "minTotalScore": { "type": "integer", "minimum": 0, "maximum": 40, "default": 30, "description": "Minimum total score across all dimensions." },
            "minDimensionScore": { "type": "integer", "minimum": 0, "maximum": 5, "default": 3, "description": "Minimum score for any single dimension." },
            "dimensions": {
              "type": "array",
              "minItems": 8,
              "maxItems": 8,
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["id", "name", "description", "signals"],
                "properties": {
                  "id": {
                    "type": "string",
                    "enum": ["actor_clarity", "ownership_routing", "sla_time", "alt_decisions", "customer_visibility", "capacity_reality", "observability", "minimal_complexity"]
                  },
                  "name": { "type": "string", "description": "Human-readable dimension name." },
                  "description": { "type": "string", "description": "What this dimension measures (0-5 scoring guidance)." },
                  "signals": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "Which requiredSignals and decision points demonstrate excellence in this dimension."
                  }
                }
              }
            }
          }
        }
      }
    },
    "diagramBudget": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "maxActors",
        "maxTotalSteps",
        "maxStepsPerBranch",
        "maxAltBlocks",
        "maxMessageChars",
        "maxNoteChars",
        "maxNotes"
      ],
      "description": "Hard limits for diagram size to ensure no-scroll, single-screen readability.",
      "properties": {
        "maxActors": {
          "type": "integer",
          "minimum": 3,
          "maximum": 9,
          "default": 7,
          "description": "Maximum number of actors/participants in the diagram."
        },
        "maxTotalSteps": {
          "type": "integer",
          "minimum": 8,
          "maximum": 40,
          "default": 18,
          "description": "Maximum total steps across the entire diagram."
        },
        "maxStepsPerBranch": {
          "type": "integer",
          "minimum": 3,
          "maximum": 20,
          "default": 8,
          "description": "Maximum steps within any single alt branch."
        },
        "maxAltBlocks": {
          "type": "integer",
          "minimum": 1,
          "maximum": 4,
          "default": 2,
          "description": "Maximum number of alt decision blocks."
        },
        "maxNotes": {
          "type": "integer",
          "minimum": 0,
          "maximum": 8,
          "default": 3,
          "description": "Maximum number of note annotations."
        },
        "maxMessageChars": {
          "type": "integer",
          "minimum": 20,
          "maximum": 90,
          "default": 56,
          "description": "Maximum character length for message text."
        },
        "maxNoteChars": {
          "type": "integer",
          "minimum": 20,
          "maximum": 140,
          "default": 90,
          "description": "Maximum character length for note text."
        },
        "targetViewport": {
          "type": "string",
          "enum": ["single_screen", "single_slide", "no_scroll"],
          "default": "no_scroll",
          "description": "Intent for how compact the diagram must be."
        },
        "layoutGuidance": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "prefer_short_actor_labels",
              "prefer_short_messages",
              "avoid_long_notes",
              "avoid_nested_alt",
              "avoid_more_than_one_return_chain",
              "limit_internal_steps",
              "use_two_phase_structure"
            ]
          },
          "default": ["prefer_short_messages", "avoid_nested_alt", "use_two_phase_structure"],
          "description": "Layout guidance rules to follow for diagram clarity."
        }
      }
    },
    "compressionRules": {
      "type": "array",
      "minItems": 5,
      "description": "Ordered priority list of compression strategies to apply when diagram exceeds budget.",
      "items": {
        "type": "string",
        "enum": [
          "merge_adjacent_steps_same_actor_pair",
          "replace_two_steps_with_one_state_change",
          "convert_detail_to_note",
          "remove_nonessential_returns",
          "shorten_messages_to_verbs",
          "collapse_system_internals_into_single_internal_step",
          "reduce_alt_branches_to_two",
          "reduce_actors_by_merging_support_roles",
          "extract_secondary_flow_into_followup_diagram"
        ]
      },
      "default": [
        "shorten_messages_to_verbs",
        "merge_adjacent_steps_same_actor_pair",
        "collapse_system_internals_into_single_internal_step",
        "reduce_alt_branches_to_two",
        "extract_secondary_flow_into_followup_diagram"
      ]
    },
    "flows": {
      "type": "object",
      "additionalProperties": false,
      "required": ["asIs", "toBe", "altDecisionPoints"],
      "properties": {
        "asIs": { "$ref": "#/$defs/sequenceFlow" },
        "toBe": { "$ref": "#/$defs/sequenceFlow" },
        "altDecisionPoints": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/altDecisionPoint" },
          "description": "Defines the alt blocks that contrast as-is vs orchestrated behaviors at real decision points."
        }
      }
    },
    "outputs": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mermaid", "article", "checklist", "scorecard", "diagramSizeScorecard"],
      "properties": {
        "mermaid": {
          "type": "object",
          "additionalProperties": false,
          "required": ["title", "autonumber", "includeNotes"],
          "properties": {
            "title": { "type": "string" },
            "autonumber": { "type": "boolean", "default": true },
            "includeNotes": { "type": "boolean", "default": true }
          }
        },
        "article": {
          "type": "object",
          "additionalProperties": false,
          "required": ["sections"],
          "properties": {
            "sections": {
              "type": "array",
              "minItems": 5,
              "items": {
                "type": "string",
                "enum": [
                  "hook",
                  "problem_in_one_minute",
                  "as_is_walkthrough",
                  "orchestrated_solution",
                  "design_principles",
                  "implementation_steps",
                  "metrics_and_slas",
                  "anti_patterns",
                  "closing"
                ]
              }
            }
          }
        },
        "checklist": {
          "type": "object",
          "additionalProperties": false,
          "required": ["items"],
          "properties": {
            "items": {
              "type": "array",
              "minItems": 8,
              "items": { "$ref": "#/$defs/checkItem" }
            }
          }
        },
        "scorecard": {
          "type": "object",
          "additionalProperties": false,
          "required": ["dimensionScores", "totalScore", "passed"],
          "description": "Quality rubric scorecard; required output to validate orchestration quality.",
          "properties": {
            "dimensionScores": {
              "type": "object",
              "additionalProperties": { "type": "integer", "minimum": 0, "maximum": 5 },
              "description": "Score for each of 8 dimensions (actor_clarity, ownership_routing, sla_time, alt_decisions, customer_visibility, capacity_reality, observability, minimal_complexity)."
            },
            "totalScore": { "type": "integer", "minimum": 0, "maximum": 40, "description": "Sum of all dimension scores." },
            "passed": { "type": "boolean", "description": "True if totalScore ≥ minTotalScore and all dimensions ≥ minDimensionScore." },
            "failureReasons": {
              "type": "array",
              "items": { "type": "string" },
              "description": "If passed=false, list reasons why (e.g., 'sla_time score is 2, requires 3')."
            }
          }
        },
        "diagramSizeScorecard": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "actorCount",
            "totalSteps",
            "altBlockCount",
            "maxStepsInAnyBranch",
            "noteCount",
            "maxMessageCharsObserved",
            "maxNoteCharsObserved",
            "passesBudget"
          ],
          "description": "Diagram size validation scorecard; required output to ensure diagrams meet budget constraints.",
          "properties": {
            "actorCount": {
              "type": "integer",
              "description": "Number of actors/participants in the diagram."
            },
            "totalSteps": {
              "type": "integer",
              "description": "Total number of steps in the diagram."
            },
            "altBlockCount": {
              "type": "integer",
              "description": "Number of alt decision blocks in the diagram."
            },
            "maxStepsInAnyBranch": {
              "type": "integer",
              "description": "Maximum steps found in any single alt branch."
            },
            "noteCount": {
              "type": "integer",
              "description": "Number of note annotations in the diagram."
            },
            "maxMessageCharsObserved": {
              "type": "integer",
              "description": "Longest message text length observed."
            },
            "maxNoteCharsObserved": {
              "type": "integer",
              "description": "Longest note text length observed."
            },
            "passesBudget": {
              "type": "boolean",
              "description": "True if all budget constraints are met."
            },
            "violations": {
              "type": "array",
              "items": { "type": "string" },
              "description": "List of budget violations if passesBudget is false."
            }
          }
        }
      }
    }
  },
  "$defs": {
    "sequenceFlow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "steps"],
      "properties": {
        "name": { "type": "string" },
        "steps": {
          "type": "array",
          "minItems": 3,
          "maxItems": 20,
          "description": "Maximum 20 steps to maintain clarity.",
          "items": { "$ref": "#/$defs/step" }
        }
      }
    },
    "step": {
      "type": "object",
      "additionalProperties": false,
      "required": ["from", "to", "action", "kind"],
      "properties": {
        "from": { "type": "string", "description": "Actor id or 'Note'." },
        "to": { "type": "string", "description": "Actor id (ignored when kind=note)." },
        "action": { "type": "string", "description": "Message text." },
        "kind": {
          "type": "string",
          "enum": ["message", "return", "note", "internal"],
          "description": "Maps to Mermaid arrows or notes."
        },
        "noteOver": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 2,
          "maxItems": 2,
          "description": "If kind=note, specify two actor ids for 'Note over A,B'."
        },
        "emits": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Telemetry/observability events emitted at this step (e.g., 'ownership_assigned', 'sla_started')."
        },
        "updates": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Case state updates as a result of this step (e.g., status: 'InProgress', owner: 'WarrantyOrchestrator')."
        }
      }
    },
    "altDecisionPoint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "branches"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-z0-9_\\-]{3,40}$" },
        "title": { "type": "string" },
        "branches": {
          "type": "array",
          "minItems": 2,
          "maxItems": 4,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["label", "criteria", "steps"],
            "properties": {
              "label": { "type": "string", "description": "e.g., Current state, Orchestrated state" },
              "criteria": { "type": "string", "description": "Condition description (human readable)." },
              "steps": {
                "type": "array",
                "minItems": 2,
                "items": { "$ref": "#/$defs/step" }
              }
            }
          }
        }
      }
    },
    "checkItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "category", "statement", "owner"],
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Z]{2,5}-[0-9]{3,5}$" },
        "category": {
          "type": "string",
          "enum": ["ownership", "sla", "routing", "visibility", "capacity", "customer_experience", "governance", "tooling"]
        },
        "statement": { "type": "string" },
        "owner": { "type": "string", "description": "Role or team (not a person)." },
        "doneDefinition": { "type": "string", "description": "Acceptance criteria for this checklist item." }
      }
    }
  }
}
